{"version":3,"file":"formily.reactive-react.umd.production.js","sources":["../../../node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js","../src/hooks/useLayoutEffect.ts","../src/shared/global.ts","../src/shared/gc.ts","../src/shared/immediate.ts","../src/hooks/useDidUpdate.ts","../src/hooks/useForceUpdate.ts","../src/hooks/useCompatEffect.ts","../src/hooks/useCompatFactory.ts","../src/hooks/useObserver.ts","../src/observer.ts","../src/hooks/index.ts"],"sourcesContent":["'use strict';\n\nvar reactIs = require('react-is');\n\n/**\n * Copyright 2015, Yahoo! Inc.\n * Copyrights licensed under the New BSD License. See the accompanying LICENSE file for terms.\n */\nvar REACT_STATICS = {\n  childContextTypes: true,\n  contextType: true,\n  contextTypes: true,\n  defaultProps: true,\n  displayName: true,\n  getDefaultProps: true,\n  getDerivedStateFromError: true,\n  getDerivedStateFromProps: true,\n  mixins: true,\n  propTypes: true,\n  type: true\n};\nvar KNOWN_STATICS = {\n  name: true,\n  length: true,\n  prototype: true,\n  caller: true,\n  callee: true,\n  arguments: true,\n  arity: true\n};\nvar FORWARD_REF_STATICS = {\n  '$$typeof': true,\n  render: true,\n  defaultProps: true,\n  displayName: true,\n  propTypes: true\n};\nvar MEMO_STATICS = {\n  '$$typeof': true,\n  compare: true,\n  defaultProps: true,\n  displayName: true,\n  propTypes: true,\n  type: true\n};\nvar TYPE_STATICS = {};\nTYPE_STATICS[reactIs.ForwardRef] = FORWARD_REF_STATICS;\nTYPE_STATICS[reactIs.Memo] = MEMO_STATICS;\n\nfunction getStatics(component) {\n  // React v16.11 and below\n  if (reactIs.isMemo(component)) {\n    return MEMO_STATICS;\n  } // React v16.12 and above\n\n\n  return TYPE_STATICS[component['$$typeof']] || REACT_STATICS;\n}\n\nvar defineProperty = Object.defineProperty;\nvar getOwnPropertyNames = Object.getOwnPropertyNames;\nvar getOwnPropertySymbols = Object.getOwnPropertySymbols;\nvar getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\nvar getPrototypeOf = Object.getPrototypeOf;\nvar objectPrototype = Object.prototype;\nfunction hoistNonReactStatics(targetComponent, sourceComponent, blacklist) {\n  if (typeof sourceComponent !== 'string') {\n    // don't hoist over string (html) components\n    if (objectPrototype) {\n      var inheritedComponent = getPrototypeOf(sourceComponent);\n\n      if (inheritedComponent && inheritedComponent !== objectPrototype) {\n        hoistNonReactStatics(targetComponent, inheritedComponent, blacklist);\n      }\n    }\n\n    var keys = getOwnPropertyNames(sourceComponent);\n\n    if (getOwnPropertySymbols) {\n      keys = keys.concat(getOwnPropertySymbols(sourceComponent));\n    }\n\n    var targetStatics = getStatics(targetComponent);\n    var sourceStatics = getStatics(sourceComponent);\n\n    for (var i = 0; i < keys.length; ++i) {\n      var key = keys[i];\n\n      if (!KNOWN_STATICS[key] && !(blacklist && blacklist[key]) && !(sourceStatics && sourceStatics[key]) && !(targetStatics && targetStatics[key])) {\n        var descriptor = getOwnPropertyDescriptor(sourceComponent, key);\n\n        try {\n          // Avoid failures from read-only properties\n          defineProperty(targetComponent, key, descriptor);\n        } catch (e) {}\n      }\n    }\n  }\n\n  return targetComponent;\n}\n\nmodule.exports = hoistNonReactStatics;\n","import { useEffect, useLayoutEffect as _useLayoutEffect } from 'react'\n\nexport const useLayoutEffect =\n  typeof document !== 'undefined' ? _useLayoutEffect : useEffect\n","/* istanbul ignore next */\nfunction globalSelf() {\n  try {\n    if (typeof self !== 'undefined') {\n      return self\n    }\n  } catch (e) {}\n  try {\n    if (typeof window !== 'undefined') {\n      return window\n    }\n  } catch (e) {}\n  try {\n    if (typeof global !== 'undefined') {\n      return global\n    }\n  } catch (e) {}\n  return Function('return this')()\n}\n\nexport const globalThisPolyfill: Window = globalSelf()\n","import { globalThisPolyfill } from './global'\n\nconst registry: FinalizationRegistry<any> =\n  globalThisPolyfill['FinalizationRegistry'] &&\n  new globalThisPolyfill['FinalizationRegistry']((token: any) =>\n    token?.clean?.()\n  )\n\ntype Token = { clean: () => void }\nexport class GarbageCollector<T extends object = any> {\n  private expireTime: number\n  private request?: ReturnType<typeof setTimeout>;\n  private token: Token\n  constructor(clean?: () => void, expireTime = 10_000) {\n    this.token = {\n      clean,\n    }\n    this.expireTime = expireTime\n  }\n\n  open(target: T) {\n    if (registry) {\n      registry.register(target, this.token, this.token)\n    } else {\n      this.request = setTimeout(() => {\n        this.token?.clean?.()\n      }, this.expireTime)\n    }\n  }\n\n  close() {\n    if (registry) {\n      registry.unregister(this.token)\n    } else {\n      clearTimeout(this.request)\n    }\n  }\n}\n","export const immediate = (callback?: () => void) => {\n  let disposed = false\n  Promise.resolve(0).then(() => {\n    if (disposed) {\n      disposed = false\n      return\n    }\n    callback()\n  })\n  return () => {\n    disposed = true\n  }\n}\n","import { useRef } from 'react'\nimport { useLayoutEffect } from './useLayoutEffect'\nimport { immediate } from '../shared'\n\nexport const useDidUpdate = (callback?: () => void) => {\n  const request = useRef(null)\n  request.current = immediate(callback)\n  useLayoutEffect(() => {\n    request.current()\n    callback()\n  })\n}\n","import { useCallback, useRef, useState } from 'react'\nimport { useLayoutEffect } from './useLayoutEffect'\nimport { useDidUpdate } from './useDidUpdate'\n\nconst EMPTY_ARRAY: any[] = []\nconst RENDER_COUNT = { value: 0 }\nconst RENDER_QUEUE = new Set<() => void>()\n\nexport function useForceUpdate() {\n  const [, setState] = useState([])\n  const firstRenderedRef = useRef(false)\n  const needUpdateRef = useRef(false)\n  useLayoutEffect(() => {\n    firstRenderedRef.current = true\n    if (needUpdateRef.current) {\n      setState([])\n      needUpdateRef.current = false\n    }\n    return () => {\n      firstRenderedRef.current = false\n    }\n  }, EMPTY_ARRAY)\n\n  const update = useCallback(() => {\n    setState([])\n  }, EMPTY_ARRAY)\n\n  const scheduler = useCallback(() => {\n    if (!firstRenderedRef.current) {\n      // 针对StrictMode无法快速回收内存，只能考虑拦截第一次渲染函数的setState，\n      // 因为第一次渲染函数的setState会触发第二次渲染函数执行，从而清理掉第二次渲染函数内部的依赖\n      needUpdateRef.current = true\n      return\n    }\n    if (RENDER_COUNT.value === 0) {\n      update()\n    } else {\n      RENDER_QUEUE.add(update)\n    }\n  }, EMPTY_ARRAY)\n\n  RENDER_COUNT.value++\n\n  useDidUpdate(() => {\n    if (RENDER_COUNT.value > 0) {\n      RENDER_COUNT.value--\n    }\n    if (RENDER_COUNT.value === 0) {\n      RENDER_QUEUE.forEach((update) => {\n        RENDER_QUEUE.delete(update)\n        update()\n      })\n    }\n  })\n\n  return scheduler\n}\n","import { useEffect, useRef, EffectCallback, DependencyList } from 'react'\nimport { immediate } from '../shared'\n\nconst isArr = Array.isArray\n\nconst isEqualDeps = (target: any, source: any) => {\n  const arrA = isArr(target)\n  const arrB = isArr(source)\n  if (arrA !== arrB) return false\n  if (arrA) {\n    if (target.length !== source.length) return false\n    return target.every((val, index) => val === source[index])\n  }\n  return target === source\n}\n\nexport const useCompatEffect = (\n  effect: EffectCallback,\n  deps?: DependencyList\n) => {\n  const depsRef = useRef<DependencyList>(null)\n  const mountedRef = useRef(false)\n  useEffect(() => {\n    mountedRef.current = true\n    const dispose = effect()\n    return () => {\n      mountedRef.current = false\n      if (!isEqualDeps(depsRef.current, deps)) {\n        if (dispose) dispose()\n        return\n      }\n      immediate(() => {\n        if (mountedRef.current) return\n        if (dispose) dispose()\n      })\n    }\n  }, deps)\n  depsRef.current = deps\n}\n","import React from 'react'\nimport { GarbageCollector } from '../shared'\nimport { useCompatEffect } from './useCompatEffect'\n\nclass ObjectToBeRetainedByReact {}\n\nfunction objectToBeRetainedByReactFactory() {\n  return new ObjectToBeRetainedByReact()\n}\n\nexport const useCompatFactory = <T extends { dispose: () => void }>(\n  factory: () => T\n): T => {\n  const instRef = React.useRef<T>(null)\n  const gcRef = React.useRef<GarbageCollector>()\n  const [objectRetainedByReact] = React.useState(\n    objectToBeRetainedByReactFactory\n  )\n  if (!instRef.current) {\n    instRef.current = factory()\n  }\n  //StrictMode/ConcurrentMode会导致组件无法正确触发UnMount，所以只能自己做垃圾回收\n  if (!gcRef.current) {\n    gcRef.current = new GarbageCollector(() => {\n      if (instRef.current) {\n        instRef.current.dispose()\n      }\n    })\n    gcRef.current.open(objectRetainedByReact)\n  }\n\n  useCompatEffect(() => {\n    gcRef.current.close()\n    return () => {\n      if (instRef.current) {\n        instRef.current.dispose()\n        instRef.current = null\n      }\n    }\n  }, [])\n  return instRef.current\n}\n","import { Tracker } from '@formily/reactive'\nimport { IObserverOptions } from '../types'\nimport { useForceUpdate } from './useForceUpdate'\nimport { useCompatFactory } from './useCompatFactory'\n\nexport const useObserver = <T extends () => any>(\n  view: T,\n  options?: IObserverOptions\n): ReturnType<T> => {\n  const forceUpdate = useForceUpdate()\n  const tracker = useCompatFactory(\n    () =>\n      new Tracker(() => {\n        if (typeof options?.scheduler === 'function') {\n          options.scheduler(forceUpdate)\n        } else {\n          forceUpdate()\n        }\n      }, options?.displayName)\n  )\n  return tracker.track(view)\n}\n","import React, { forwardRef, memo, Fragment } from 'react'\nimport hoistNonReactStatics from 'hoist-non-react-statics'\nimport { useObserver } from './hooks/useObserver'\nimport { IObserverOptions, IObserverProps, ReactFC } from './types'\n\nexport function observer<\n  P,\n  Options extends IObserverOptions = IObserverOptions\n>(\n  component: ReactFC<P>,\n  options?: Options\n): React.MemoExoticComponent<\n  ReactFC<\n    Options extends { forwardRef: true }\n      ? P & {\n          ref?: 'ref' extends keyof P ? P['ref'] : React.RefAttributes<any>\n        }\n      : React.PropsWithoutRef<P>\n  >\n> {\n  const realOptions = {\n    forwardRef: false,\n    ...options,\n  }\n\n  const wrappedComponent = realOptions.forwardRef\n    ? forwardRef((props: any, ref: any) => {\n        return useObserver(() => component({ ...props, ref }), realOptions)\n      })\n    : (props: any) => {\n        return useObserver(() => component(props), realOptions)\n      }\n\n  const memoComponent = memo(wrappedComponent)\n\n  hoistNonReactStatics(memoComponent, component)\n\n  if (realOptions.displayName) {\n    memoComponent.displayName = realOptions.displayName\n  }\n\n  return memoComponent\n}\n\nexport const Observer = observer((props: IObserverProps) => {\n  const children =\n    typeof props.children === 'function' ? props.children() : props.children\n  return React.createElement(Fragment, {}, children)\n})\n","import { useForceUpdate } from './useForceUpdate'\nimport { useCompatEffect } from './useCompatEffect'\nimport { useCompatFactory } from './useCompatFactory'\nimport { useDidUpdate } from './useDidUpdate'\nimport { useLayoutEffect } from './useLayoutEffect'\nimport { useObserver } from './useObserver'\n\nexport const unstable_useForceUpdate = useForceUpdate\nexport const unstable_useCompatEffect = useCompatEffect\nexport const unstable_useCompatFactory = useCompatFactory\nexport const unstable_useDidUpdate = useDidUpdate\nexport const unstable_useLayoutEffect = useLayoutEffect\nexport const unstable_useObserver = useObserver\n"],"names":["REACT_STATICS","childContextTypes","contextType","contextTypes","defaultProps","displayName","getDefaultProps","getDerivedStateFromError","getDerivedStateFromProps","mixins","propTypes","type","KNOWN_STATICS","name","length","prototype","caller","callee","arguments","arity","MEMO_STATICS","$$typeof","compare","TYPE_STATICS","getStatics","component","reactIs","isMemo","ForwardRef","render","Memo","defineProperty","Object","getOwnPropertyNames","getOwnPropertySymbols","getOwnPropertyDescriptor","getPrototypeOf","objectPrototype","hoistNonReactStatics_cjs","hoistNonReactStatics","targetComponent","sourceComponent","blacklist","inheritedComponent","keys","concat","targetStatics","sourceStatics","i","key","descriptor","e","useLayoutEffect","document","React","useEffect","globalThisPolyfill","self","window","global","Function","globalSelf","registry","token","_a","clean","call","GarbageCollector","expireTime","this","open","target","_this","register","request","setTimeout","_b","close","unregister","clearTimeout","immediate","callback","disposed","Promise","resolve","then","useDidUpdate","useRef","current","EMPTY_ARRAY","RENDER_COUNT","value","RENDER_QUEUE","Set","useForceUpdate","setState","useState","firstRenderedRef","needUpdateRef","useCallback","update","add","forEach","delete","scheduler","isArr","Array","isArray","useCompatEffect","effect","deps","depsRef","mountedRef","dispose","source","arrA","every","val","index","ObjectToBeRetainedByReact","objectToBeRetainedByReactFactory","useCompatFactory","factory","gcRef","objectRetainedByReact","__read","instRef","useObserver","view","options","forceUpdate","Formily","Reactive","Tracker","track","observer","wrappedComponent","realOptions","forwardRef","props","ref","__assign","memoComponent","memo","Observer","Fragment","children","unstable_useForceUpdate","unstable_useCompatEffect","unstable_useCompatFactory","unstable_useDidUpdate","unstable_useLayoutEffect","unstable_useObserver"],"mappings":"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"}