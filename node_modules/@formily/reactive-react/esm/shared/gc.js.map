{"version":3,"file":"gc.js","sourceRoot":"","sources":["../../src/shared/gc.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,kBAAkB,EAAE,MAAM,UAAU,CAAA;AAE7C,IAAM,QAAQ,GACZ,kBAAkB,CAAC,sBAAsB,CAAC;IAC1C,IAAI,kBAAkB,CAAC,sBAAsB,CAAC,CAAC,UAAC,KAAU,YACxD,OAAA,MAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,KAAK,qDAAI,CAAA,EAAA,CACjB,CAAA;AAGH;IAIE,0BAAY,KAAkB,EAAE,UAAmB;QAAnB,2BAAA,EAAA,kBAAmB;QACjD,IAAI,CAAC,KAAK,GAAG;YACX,KAAK,OAAA;SACN,CAAA;QACD,IAAI,CAAC,UAAU,GAAG,UAAU,CAAA;IAC9B,CAAC;IAED,+BAAI,GAAJ,UAAK,MAAS;QAAd,iBAQC;QAPC,IAAI,QAAQ,EAAE;YACZ,QAAQ,CAAC,QAAQ,CAAC,MAAM,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,CAAA;SAClD;aAAM;YACL,IAAI,CAAC,OAAO,GAAG,UAAU,CAAC;;gBACxB,MAAA,MAAA,KAAI,CAAC,KAAK,0CAAE,KAAK,kDAAI,CAAA;YACvB,CAAC,EAAE,IAAI,CAAC,UAAU,CAAC,CAAA;SACpB;IACH,CAAC;IAED,gCAAK,GAAL;QACE,IAAI,QAAQ,EAAE;YACZ,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;SAChC;aAAM;YACL,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;SAC3B;IACH,CAAC;IACH,uBAAC;AAAD,CAAC,AA5BD,IA4BC","sourcesContent":["import { globalThisPolyfill } from './global'\n\nconst registry: FinalizationRegistry<any> =\n  globalThisPolyfill['FinalizationRegistry'] &&\n  new globalThisPolyfill['FinalizationRegistry']((token: any) =>\n    token?.clean?.()\n  )\n\ntype Token = { clean: () => void }\nexport class GarbageCollector<T extends object = any> {\n  private expireTime: number\n  private request?: ReturnType<typeof setTimeout>;\n  private token: Token\n  constructor(clean?: () => void, expireTime = 10_000) {\n    this.token = {\n      clean,\n    }\n    this.expireTime = expireTime\n  }\n\n  open(target: T) {\n    if (registry) {\n      registry.register(target, this.token, this.token)\n    } else {\n      this.request = setTimeout(() => {\n        this.token?.clean?.()\n      }, this.expireTime)\n    }\n  }\n\n  close() {\n    if (registry) {\n      registry.unregister(this.token)\n    } else {\n      clearTimeout(this.request)\n    }\n  }\n}\n"]}