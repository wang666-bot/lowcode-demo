!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define("formily.json-schema",["exports"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self).Formily=e.Formily||{},e.Formily.JSONSchema={}))}(this,(function(e){"use strict";!function(){const e={NODE_ENV:"production"};try{if(process)return process.env=Object.assign({},process.env),void Object.assign(process.env,e)}catch(e){}globalThis.process={env:e}}();var r=Symbol.for("__REVA_ACTIONS"),t={parent:!0,root:!0,properties:!0,patternProperties:!0,additionalProperties:!0,items:!0,additionalItems:!0,"x-linkages":!0,"x-reactions":!0},i={title:"title",description:"description",default:"initialValue",enum:"dataSource",readOnly:"readOnly",writeOnly:"editable","x-content":"content","x-data":"data","x-value":"value","x-editable":"editable","x-disabled":"disabled","x-read-pretty":"readPretty","x-read-only":"readOnly","x-visible":"visible","x-hidden":"hidden","x-display":"display","x-pattern":"pattern","x-validator":"validator","x-decorator":"decoratorType","x-component":"componentType","x-decorator-props":"decoratorProps","x-component-props":"componentProps"},n={required:!0,format:!0,maxItems:!0,minItems:!0,maxLength:!0,minLength:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,pattern:!0,const:!0,multipleOf:!0,maxProperties:!0,minProperties:!0,uniqueItems:!0},o=Object.prototype.hasOwnProperty,a=function(e){return"$$typeof"in e&&"_owner"in e||(!!e._isAMomentObject||(!!M.isSchemaInstance(e)||(!!e[r]||(!!Formily.Shared.isFn(e.toJS)||(!!Formily.Shared.isFn(e.toJSON)||!!Formily.Reactive.isObservable(e))))))},l=function(e,r,t){Formily.Reactive.untracked((function(){var o,a,l=Formily.Shared.FormPath.parse(r).segments,s=l[0],d="enum"===s&&Formily.Shared.isArr(t),u=i[s];u?Formily.Shared.FormPath.setIn(e,[u].concat(l.slice(1)),d?(a=t,Formily.Shared.toArr(a).map((function(e){return"object"==typeof e?e:{label:e,value:e}}))):t):n[s]&&(null===(o=e.setValidatorRule)||void 0===o||o.call(e,s,t))}))},s=/^\s*\{\{([\s\S]*)\}\}\s*$/,d={silent:!1,compile:function(e,r){if(void 0===r&&(r={}),!d.silent)return new Function("$root","with($root) { return (".concat(e,"); }"))(r);try{return new Function("$root","with($root) { return (".concat(e,"); }"))(r)}catch(e){}}},u=function(e){void 0===e&&(e=!0),d.silent=!!e},c=function(e){Formily.Shared.isFn(e)&&(d.compile=e)},f=function(e,r){if(Formily.Shared.isStr(e)){var t=e.match(s);return t?d.compile(t[1],r):e}return e},p=function(e,r){var t=[],i=function(e){if(Formily.Shared.isStr(e))return f(e,r);if(Formily.Shared.isArr(e))return e.map((function(e){return i(e)}));if(Formily.Shared.isPlainObj(e)){if(a(e))return e;if(t.indexOf(e)>-1)return e;var n=t.length;t.push(e);var o=Formily.Shared.reduce(e,(function(e,r,t){return e[t]=i(r),e}),{});return t.splice(n,1),o}return e};return i(e)},m=function(e,r,t){!function(e,r){var t=[],i=e,n=function(e,o){if(void 0===o&&(o=[]),Formily.Shared.isPlainObj(e)){if(t.indexOf(e)>-1)return;var l=t.length;if(t.push(e),a(e)&&i!==e)return void r(e,o);Formily.Shared.each(e,(function(e,r){n(e,o.concat(r))})),t.splice(l,1)}else r(e,o)};n(e)}(r,(function(r,i){var n=p(r,t);if(void 0!==n){var a=Formily.Shared.FormPath.parse(i),l=a.segments[0];o.call(e,l)&&Formily.Reactive.untracked((function(){return Formily.Shared.FormPath.setIn(e,a,n)}))}}))},h=function(e,r,i,n){void 0===n&&(n=!1),function(e,r){var i;void 0!==e["x-validator"]&&r(e["x-validator"],["x-validator"],null===(i=e["x-compile-omitted"])||void 0===i?void 0:i.includes("x-validator"));var n=[],o=e,l=function(i,s){var d;if(void 0===s&&(s=[]),"x-compile-omitted"!==s[0]&&"x-validator"!==s[0]&&"version"!==s[0]&&"_isJSONSchemaObject"!==s[0]&&!(-1==String(s[0]).indexOf("x-")&&Formily.Shared.isFn(i)||t[s[0]]))if((null===(d=e["x-compile-omitted"])||void 0===d?void 0:d.indexOf(s[0]))>-1)r(i,s,!0);else if(Formily.Shared.isPlainObj(i)){if("default"===s[0]||"x-value"===s[0])return void r(i,s);if(n.indexOf(i)>-1)return;var u=n.length;if(n.push(i),a(i)&&o!==i)return void r(i,s);Formily.Shared.each(i,(function(e,r){l(e,s.concat(r))})),n.splice(u,1)}else r(i,s)};l(e)}(r,(function(r,t,o){var a=r,s=Formily.Reactive.hasCollected((function(){o||(a=p(r,i))}));void 0!==a&&(n&&!s&&e.initialized||l(e,t,a))}))},y=function(){return y=Object.assign||function(e){for(var r,t=1,i=arguments.length;t<i;t++)for(var n in r=arguments[t])Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e},y.apply(this,arguments)};function v(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var i,n,o=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(e){n={error:e}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(n)throw n.error}}return a}"function"==typeof SuppressedError&&SuppressedError;var F={onFieldInit:Formily.Core.onFieldInit,onFieldMount:Formily.Core.onFieldMount,onFieldUnmount:Formily.Core.onFieldUnmount,onFieldValueChange:Formily.Core.onFieldValueChange,onFieldInputValueChange:Formily.Core.onFieldInputValueChange,onFieldInitialValueChange:Formily.Core.onFieldInitialValueChange,onFieldValidateStart:Formily.Core.onFieldValidateStart,onFieldValidateEnd:Formily.Core.onFieldValidateEnd,onFieldValidateFailed:Formily.Core.onFieldValidateFailed,onFieldValidateSuccess:Formily.Core.onFieldValidateSuccess},S=["onFieldInit","onFieldValueChange"],x=function(e,r,t){var i=v(String(r).split(/\s*#\s*/),2),n=i[0],o=i[1];return e.query(n).getIn(o||t||"value")},g=function(e,r){void 0===r&&(r=!1);var t=e||{},i=t.request,n=t.target,o=t.runner,a=t.field,l=t.scope;i&&(n?(i.state&&a.form.setFieldState(n,(function(e){return m(e,i.state,Formily.Shared.lazyMerge(l,{$target:e}))})),i.schema&&a.form.setFieldState(n,(function(e){return h(e,i.schema,Formily.Shared.lazyMerge(l,{$target:e}),r)})),Formily.Shared.isStr(o)&&o&&a.form.setFieldState(n,(function(e){f("{{function(){".concat(o,"}}}"),Formily.Shared.lazyMerge(l,{$target:e}))()}))):(i.state&&a.setState((function(e){return m(e,i.state,l)})),i.schema&&a.setState((function(e){return h(e,i.schema,l,r)})),Formily.Shared.isStr(o)&&o&&f("{{function(){".concat(o,"}}}"),l)()))},P=function(e,r){void 0===r&&(r={});var t=Formily.Reactive.autorun.effect,i=Formily.Reactive.autorun.memo,n=e,o=e.form,a=e.form.values;return Formily.Shared.lazyMerge({get $lookup(){var e,t;return null!==(t=null===(e=null==r?void 0:r.scope)||void 0===e?void 0:e.$record)&&void 0!==t?t:a},get $records(){return e.records},get $record(){var t=e.record;return"object"==typeof t?Formily.Shared.lazyMerge(t,{get $lookup(){var e,t;return null!==(t=null===(e=null==r?void 0:r.scope)||void 0===e?void 0:e.$record)&&void 0!==t?t:a},get $index(){return e.index}}):t},get $index(){return e.index}},r.scope,{$form:o,$self:n,$observable:function(e,r){return Formily.Reactive.autorun.memo((function(){return Formily.Reactive.observable(e)}),r)},$effect:t,$memo:i,$props:function(r){return e.setComponentProps(r)},$values:a})},b=function(e,r){return function(t){g({field:t,request:{schema:e},scope:P(t,r)},!0)}},O=function(e,r){return Formily.Shared.toArr(e["x-reactions"]).map((function(e){return function(t){var i=P(t,r),n=f(e,i);if(n){if(Formily.Shared.isFn(n))return n(t,i);var o=n.when,a=n.fulfill,l=n.otherwise,s=n.target,d=n.effects,u=function(){var e=function(e,r){if(Formily.Shared.isArr(r)){var t=[];return r.forEach((function(r){Formily.Shared.isStr(r)?t.push(x(e,r)):Formily.Shared.isPlainObj(r)&&r.name&&r.source&&(t[r.name]=x(e,r.source,r.property))})),t}return Formily.Shared.isPlainObj(r)?Formily.Shared.reduce(r,(function(r,t,i){return r[i]=x(e,t),r}),{}):[]}(t,n.dependencies),r=e,d=Formily.Shared.lazyMerge(i,{$target:null,$deps:e,$dependencies:r}),u=f(o,d),c=!o||u?a:l,p=null==c?void 0:c.run;g({field:t,target:s,request:c,runner:p,scope:d})};s&&(n.effects=(null==d?void 0:d.length)?d:S),n.effects?Formily.Reactive.autorun.memo((function(){Formily.Reactive.untracked((function(){Formily.Shared.each(n.effects,(function(e){F[e]&&F[e](t.address,u)}))}))}),[]):u()}}}))},$=[],w={},I=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];e.forEach((function(e){Formily.Shared.isFn(e)&&$.push(e)}))},C=function(e,r){e&&Formily.Shared.isFn(r)&&(w[e]=w[e]||[],w[e].push(r))},V=function(e){Formily.Shared.isArr(e)&&e.forEach((function(e){Formily.Shared.isArr(w[e])&&w[e].forEach((function(e){I(e)}))}))},A=["card","block","grid-col","grid-row","grid","layout","step","tab","text-box"],j={},N=function(e){if(Formily.Shared.isStr(e))return e.replace(/\$value/,"$self.value")},k=function(e){var r;return Formily.Shared.isValid(e.editable)&&(e["x-editable"]=e["x-editable"]||e.editable,delete e.editable),Formily.Shared.isValid(e.visible)&&(e["x-visible"]=e["x-visible"]||e.visible,delete e.visible),Formily.Shared.isValid(e.display)&&(e["x-display"]=e["x-display"]||(e.display?"visible":"hidden"),delete e.display),Formily.Shared.isValid(e["x-props"])&&(e["x-decorator-props"]=e["x-decorator-props"]||e["x-props"],delete e.display),e["x-linkages"]&&(e["x-reactions"]=Formily.Shared.toArr(e["x-reactions"]).concat((r=e["x-linkages"],Formily.Shared.isArr(r)?r.reduce((function(e,r){return r?"value:visible"===r.type?e.concat({target:r.target,when:N(r.condition),fulfill:{state:{visible:!0}},otherwise:{state:{visible:!1}}}):"value:schema"===r.type?e.concat({target:r.target,when:N(r.condition),fulfill:{schema:k(y({version:"1.0"},r.schema))},otherwise:{schema:k(y({version:"1.0"},r.otherwise))}}):"value:state"===r.type?e.concat({target:r.target,when:N(r.condition),fulfill:{state:r.state},otherwise:{state:r.otherwise}}):void 0:e}),[]):[])),delete e["x-linkages"]),e["x-component"]?A.some((function(r){return Formily.Shared.lowerCase(r)===Formily.Shared.lowerCase(e["x-component"])}))&&(e.type="void"):j[e.type]&&(e["x-component"]=j[e.type]),e["x-decorator"]||"void"===e.type||"object"===e.type||(e["x-decorator"]=e["x-decorator"]||"FormItem"),e["x-rules"]&&(e["x-validator"]=[].concat(e["x-validator"]||[]).concat(e["x-rules"])),e};C("1.0",k);var E=function(e){A.push.apply(A,function(e,r,t){if(t||2===arguments.length)for(var i,n=0,o=r.length;n<o;n++)!i&&n in r||(i||(i=Array.prototype.slice.call(r,0,n)),i[n]=r[n]);return e.concat(i||Array.prototype.slice.call(r))}([],v(e),!1))},J=function(e){Object.assign(j,e)},M=function(){function e(r,i){var n=this;return this._isJSONSchemaObject=!0,this.version="2.0",this.addProperty=function(r,t){return n.properties=n.properties||{},n.properties[r]=new e(t,n),n.properties[r].name=r,n.properties[r]},this.removeProperty=function(e){var r=n.properties[e];return delete n.properties[e],r},this.setProperties=function(e){for(var r in e)n.addProperty(r,e[r]);return n},this.addPatternProperty=function(r,t){if(t)return n.patternProperties=n.patternProperties||{},n.patternProperties[r]=new e(t,n),n.patternProperties[r].name=r,n.patternProperties[r]},this.removePatternProperty=function(e){var r=n.patternProperties[e];return delete n.patternProperties[e],r},this.setPatternProperties=function(e){if(!e)return n;for(var r in e)n.addPatternProperty(r,e[r]);return n},this.setAdditionalProperties=function(r){if(r)return n.additionalProperties=new e(r),n.additionalProperties},this.setItems=function(r){if(r)return Array.isArray(r)?n.items=r.map((function(r){return new e(r,n)})):n.items=new e(r,n),n.items},this.setAdditionalItems=function(r){if(r)return n.additionalItems=new e(r,n),n.additionalItems},this.findDefinitions=function(e){if(e&&n.root&&Formily.Shared.isStr(e)&&0===e.indexOf("#/"))return Formily.Shared.FormPath.getIn(n.root,e.substring(2).split("/"))},this.mapProperties=function(r){return e.getOrderProperties(n).map((function(e,t){var i=e.schema,n=e.key;return r(i,n,t)}))},this.mapPatternProperties=function(r){return e.getOrderProperties(n,"patternProperties").map((function(e,t){var i=e.schema,n=e.key;return r(i,n,t)}))},this.reduceProperties=function(r,t){var i=t;return e.getOrderProperties(n,"properties").forEach((function(e,t){var n=e.schema,o=e.key;i=r(i,n,o,t)})),i},this.reducePatternProperties=function(r,t){var i=t;return e.getOrderProperties(n,"patternProperties").forEach((function(e,t){var n=e.schema,o=e.key;i=r(i,n,o,t)})),i},this.compile=function(r){var i=new e({},n.parent);return Formily.Shared.each(n,(function(e,n){Formily.Shared.isFn(e)&&!n.includes("x-")||"parent"!==n&&"root"!==n&&(i[n]=t[n]?e?f(e,r):e:e?p(e,r):e)})),i},this.fromJSON=function(r){return r?e.isSchemaInstance(r)?r:(Formily.Shared.each((t=r,$.reduce((function(e,r){return r(e)}),y({},t))),(function(e,r){Formily.Shared.isFn(e)&&!r.includes("x-")||("properties"===r?n.setProperties(e):"patternProperties"===r?n.setPatternProperties(e):"additionalProperties"===r?n.setAdditionalProperties(e):"items"===r?n.setItems(e):"additionalItems"===r?n.setAdditionalItems(e):"$ref"===r?n.fromJSON(n.findDefinitions(e)):n[r]=e)})),n):n;var t},this.toJSON=function(e){void 0===e&&(e=!0);var r={};return Formily.Shared.each(n,(function(t,i){var n,o;if((!Formily.Shared.isFn(t)||i.includes("x-"))&&"parent"!==i&&"root"!==i)if("properties"===i||"patternProperties"===i){if(!e)return;r[i]=Formily.Shared.map(t,(function(e){var r;return null===(r=null==e?void 0:e.toJSON)||void 0===r?void 0:r.call(e)}))}else if("additionalProperties"===i||"additionalItems"===i){if(!e)return;r[i]=null===(n=null==t?void 0:t.toJSON)||void 0===n?void 0:n.call(t)}else if("items"===i){if(!e)return;Array.isArray(t)?r[i]=t.map((function(e){var r;return null===(r=null==e?void 0:e.toJSON)||void 0===r?void 0:r.call(e)})):r[i]=null===(o=null==t?void 0:t.toJSON)||void 0===o?void 0:o.call(t)}else r[i]=t})),r},this.toFieldProps=function(e){return function(e,r){return{name:e.name,reactions:[b(e,r)].concat(O(e,r))}}(n,e)},i?(this.parent=i,this.root=i.root):this.root=this,this.fromJSON(r)}return e.getOrderProperties=function(e,r){void 0===e&&(e={}),void 0===r&&(r="properties");var t=[],i=[];for(var n in e[r]){var o=e[r][n],a=o["x-index"];isNaN(a)?i.push({schema:o,key:n}):t[a]={schema:o,key:n}}return t.concat(i).filter((function(e){return!!e}))},e.compile=function(e,r){return p(e,r)},e.shallowCompile=function(e,r){return f(e,r)},e.isSchemaInstance=function(r){return Formily.Shared.instOf(r,e)},e.registerCompiler=c,e.registerPatches=I,e.registerVoidComponents=E,e.registerTypeDefaultComponents=J,e.registerPolyfills=C,e.enablePolyfills=V,e.silent=u,e}();e.Schema=M,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=formily.json-schema.umd.production.js.map
