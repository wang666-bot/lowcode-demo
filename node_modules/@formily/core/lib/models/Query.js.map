{"version":3,"file":"Query.js","sourceRoot":"","sources":["../../src/models/Query.ts"],"names":[],"mappings":"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","sourcesContent":["import { FormPath, isFn, each, FormPathPattern } from '@formily/shared'\nimport { buildDataPath } from '../shared/internals'\nimport { GeneralField, IGeneralFieldState, IQueryProps } from '../types'\nimport { Form } from './Form'\n\nconst output = (\n  field: GeneralField,\n  taker: (field: GeneralField, address: FormPath) => any\n) => {\n  if (!field) return\n  if (isFn(taker)) {\n    return taker(field, field.address)\n  }\n  return field\n}\n\nconst takeMatchPattern = (form: Form, pattern: FormPath) => {\n  const identifier = pattern.toString()\n  const indexIdentifier = form.indexes[identifier]\n  const absoluteField = form.fields[identifier]\n  const indexField = form.fields[indexIdentifier]\n  if (absoluteField) {\n    return identifier\n  } else if (indexField) {\n    return indexIdentifier\n  }\n}\n\nexport class Query {\n  private pattern: FormPath\n  private addresses: string[] = []\n  private form: Form\n  constructor(props: IQueryProps) {\n    this.pattern = FormPath.parse(props.pattern, props.base)\n    this.form = props.form\n    if (!this.pattern.isMatchPattern) {\n      const matched = takeMatchPattern(\n        this.form,\n        this.pattern.haveRelativePattern\n          ? buildDataPath(props.form.fields, this.pattern)\n          : this.pattern\n      )\n      if (matched) {\n        this.addresses = [matched]\n      }\n    } else {\n      each(this.form.fields, (field, address) => {\n        if (!field) {\n          delete this.form.fields[address]\n          return\n        }\n        if (field.match(this.pattern)) {\n          this.addresses.push(address)\n        }\n      })\n    }\n  }\n\n  take(): GeneralField | undefined\n  take<Result>(\n    getter: (field: GeneralField, address: FormPath) => Result\n  ): Result\n  take(taker?: any): any {\n    return output(this.form.fields[this.addresses[0]], taker)\n  }\n\n  map(): GeneralField[]\n  map<Result>(\n    iterator?: (field: GeneralField, address: FormPath) => Result\n  ): Result[]\n  map(iterator?: any): any {\n    return this.addresses.map((address) =>\n      output(this.form.fields[address], iterator)\n    )\n  }\n\n  forEach<Result>(\n    iterator: (field: GeneralField, address: FormPath) => Result\n  ) {\n    return this.addresses.forEach((address) =>\n      output(this.form.fields[address], iterator)\n    )\n  }\n\n  reduce<Result>(\n    reducer: (value: Result, field: GeneralField, address: FormPath) => Result,\n    initial?: Result\n  ): Result {\n    return this.addresses.reduce(\n      (value, address) =>\n        output(this.form.fields[address], (field, address) =>\n          reducer(value, field, address)\n        ),\n      initial\n    )\n  }\n\n  get<K extends keyof IGeneralFieldState>(key: K): IGeneralFieldState[K] {\n    const results: any = this.take()\n    if (results) {\n      return results[key]\n    }\n  }\n\n  getIn(pattern?: FormPathPattern) {\n    return FormPath.getIn(this.take(), pattern)\n  }\n\n  value() {\n    return this.get('value')\n  }\n\n  initialValue() {\n    return this.get('initialValue')\n  }\n}\n"]}