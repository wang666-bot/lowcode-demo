{"version":3,"file":"effective.js","sourceRoot":"","sources":["../../src/shared/effective.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,0CAA+C;AAC/C,oCAA2C;AAE3C,uCAAmC;AACnC,yCAAyC;AAElC,IAAM,gBAAgB,GAAG,UAG9B,IAAY,EACZ,QAAY;IAEZ,OAAO;QAAC,cAAkC;aAAlC,UAAkC,EAAlC,qBAAkC,EAAlC,IAAkC;YAAlC,yBAAkC;;QACxC,IAAI,uBAAW,CAAC,WAAW,EAAE;YAC3B,uBAAW,CAAC,UAAU,CAAC,IAAI,CACzB,IAAI,kBAAS,CAAC,IAAI,EAAE,UAAC,OAAO,EAAE,GAAG;gBAC/B,IAAI,IAAA,aAAI,EAAC,QAAQ,CAAC,EAAE;oBAClB,QAAQ,8BAAC,OAAO,EAAE,GAAG,UAAK,uBAAW,CAAC,OAAO,kDAAK,IAAI,WAAC;iBACxD;YACH,CAAC,CAAC,CACH,CAAA;SACF;aAAM;YACL,MAAM,IAAI,KAAK,CACb,2DAA2D,CAC5D,CAAA;SACF;IACH,CAAC,CAAA;AACH,CAAC,CAAA;AArBY,QAAA,gBAAgB,oBAqB5B;AAEM,IAAM,mBAAmB,GAAG,UAAU,YAAgB;IAC3D,IAAI,KAAa,CAAA;IACjB,OAAO;QACL,OAAO,EAAP,UAAQ,KAAS;YACf,IAAI,uBAAW,CAAC,WAAW,EAAE;gBAC3B,KAAK,GAAG,uBAAW,CAAC,OAAO,CAAC,MAAM,CAAA;gBAClC,uBAAW,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,IAAA,gBAAO,EAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,YAAY,CAAA;aACnE;iBAAM;gBACL,MAAM,IAAI,KAAK,CACb,6DAA6D,CAC9D,CAAA;aACF;QACH,CAAC;QACD,OAAO,EAAP;YACE,IAAI,CAAC,uBAAW,CAAC,WAAW,EAAE;gBAC5B,MAAM,IAAI,KAAK,CACb,6DAA6D,CAC9D,CAAA;aACF;YACD,OAAO,uBAAW,CAAC,OAAO,CAAC,KAAK,CAAC,CAAA;QACnC,CAAC;KACF,CAAA;AACH,CAAC,CAAA;AAtBY,QAAA,mBAAmB,uBAsB/B;AAED,IAAM,iBAAiB,GAAG,IAAA,2BAAmB,GAAQ,CAAA;AAExC,QAAA,aAAa,GAAG,iBAAiB,CAAC,OAAO,CAAA;AAE/C,IAAM,UAAU,GAAG,UACxB,OAAiB;IACjB,cAAuC;SAAvC,UAAuC,EAAvC,qBAAuC,EAAvC,IAAuC;QAAvC,6BAAuC;;IAEvC,uBAAW,CAAC,UAAU,GAAG,EAAE,CAAA;IAC3B,uBAAW,CAAC,OAAO,GAAG,EAAE,CAAA;IACxB,uBAAW,CAAC,WAAW,GAAG,IAAI,CAAA;IAC9B,uBAAW,CAAC,SAAS,GAAG,KAAK,CAAA;IAC7B,IAAI,IAAA,iBAAM,EAAC,OAAO,CAAC,EAAE;QACnB,iBAAiB,CAAC,OAAO,CAAC,OAAO,CAAC,CAAA;KACnC;IACD,IAAI,CAAC,OAAO,CAAC,UAAC,OAAO;QACnB,IAAI,IAAA,aAAI,EAAC,OAAO,CAAC,EAAE;YACjB,OAAO,CAAC,OAAO,CAAC,CAAA;SACjB;IACH,CAAC,CAAC,CAAA;IACF,uBAAW,CAAC,OAAO,GAAG,EAAE,CAAA;IACxB,uBAAW,CAAC,WAAW,GAAG,KAAK,CAAA;IAC/B,uBAAW,CAAC,SAAS,GAAG,IAAI,CAAA;IAC5B,OAAO,uBAAW,CAAC,UAAU,CAAA;AAC/B,CAAC,CAAA;AApBY,QAAA,UAAU,cAoBtB","sourcesContent":["import { isFn, isValid } from '@formily/shared'\nimport { LifeCycle, Form } from '../models'\nimport { AnyFunction } from '../types'\nimport { isForm } from './checkers'\nimport { GlobalState } from './constants'\n\nexport const createEffectHook = <\n  F extends (payload: any, ...ctxs: any[]) => AnyFunction\n>(\n  type: string,\n  callback?: F\n) => {\n  return (...args: Parameters<ReturnType<F>>) => {\n    if (GlobalState.effectStart) {\n      GlobalState.lifecycles.push(\n        new LifeCycle(type, (payload, ctx) => {\n          if (isFn(callback)) {\n            callback(payload, ctx, ...GlobalState.context)(...args)\n          }\n        })\n      )\n    } else {\n      throw new Error(\n        'Effect hooks cannot be used in asynchronous function body'\n      )\n    }\n  }\n}\n\nexport const createEffectContext = <T = any>(defaultValue?: T) => {\n  let index: number\n  return {\n    provide(value?: T) {\n      if (GlobalState.effectStart) {\n        index = GlobalState.context.length\n        GlobalState.context[index] = isValid(value) ? value : defaultValue\n      } else {\n        throw new Error(\n          'Provide method cannot be used in asynchronous function body'\n        )\n      }\n    },\n    consume(): T {\n      if (!GlobalState.effectStart) {\n        throw new Error(\n          'Consume method cannot be used in asynchronous function body'\n        )\n      }\n      return GlobalState.context[index]\n    },\n  }\n}\n\nconst FormEffectContext = createEffectContext<Form>()\n\nexport const useEffectForm = FormEffectContext.consume\n\nexport const runEffects = <Context>(\n  context?: Context,\n  ...args: ((context: Context) => void)[]\n): LifeCycle[] => {\n  GlobalState.lifecycles = []\n  GlobalState.context = []\n  GlobalState.effectStart = true\n  GlobalState.effectEnd = false\n  if (isForm(context)) {\n    FormEffectContext.provide(context)\n  }\n  args.forEach((effects) => {\n    if (isFn(effects)) {\n      effects(context)\n    }\n  })\n  GlobalState.context = []\n  GlobalState.effectStart = false\n  GlobalState.effectEnd = true\n  return GlobalState.lifecycles\n}\n"]}