{"version":3,"file":"onFieldEffects.js","sourceRoot":"","sources":["../../src/effects/onFieldEffects.ts"],"names":[],"mappings":"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","sourcesContent":["import { FormPath, isFn, toArr } from '@formily/shared'\nimport { autorun, reaction, batch } from '@formily/reactive'\nimport { Form } from '../models'\nimport {\n  LifeCycleTypes,\n  FormPathPattern,\n  GeneralField,\n  DataField,\n  IFieldState,\n} from '../types'\nimport { createEffectHook, useEffectForm } from '../shared/effective'\n\nfunction createFieldEffect<Result extends GeneralField = GeneralField>(\n  type: LifeCycleTypes\n) {\n  return createEffectHook(\n    type,\n    (field: Result, form: Form) =>\n      (\n        pattern: FormPathPattern,\n        callback: (field: Result, form: Form) => void\n      ) => {\n        if (\n          FormPath.parse(pattern).matchAliasGroup(field.address, field.path)\n        ) {\n          batch(() => {\n            callback(field, form)\n          })\n        }\n      }\n  )\n}\nconst _onFieldInit = createFieldEffect(LifeCycleTypes.ON_FIELD_INIT)\nexport const onFieldMount = createFieldEffect(LifeCycleTypes.ON_FIELD_MOUNT)\nexport const onFieldUnmount = createFieldEffect(LifeCycleTypes.ON_FIELD_UNMOUNT)\nexport const onFieldValueChange = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_VALUE_CHANGE\n)\nexport const onFieldInitialValueChange = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_INITIAL_VALUE_CHANGE\n)\nexport const onFieldInputValueChange = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_INPUT_VALUE_CHANGE\n)\nexport const onFieldValidateStart = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_VALIDATE_START\n)\nexport const onFieldValidateEnd = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_VALIDATE_END\n)\nexport const onFieldValidating = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_VALIDATING\n)\nexport const onFieldValidateFailed = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_VALIDATE_FAILED\n)\nexport const onFieldValidateSuccess = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_VALIDATE_SUCCESS\n)\nexport const onFieldSubmit = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT\n)\nexport const onFieldSubmitStart = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_START\n)\nexport const onFieldSubmitEnd = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_END\n)\nexport const onFieldSubmitValidateStart = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_VALIDATE_START\n)\nexport const onFieldSubmitValidateEnd = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_VALIDATE_END\n)\nexport const onFieldSubmitSuccess = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_SUCCESS\n)\nexport const onFieldSubmitFailed = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_FAILED\n)\nexport const onFieldSubmitValidateSuccess = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_VALIDATE_SUCCESS\n)\nexport const onFieldSubmitValidateFailed = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_SUBMIT_VALIDATE_FAILED\n)\nexport const onFieldReset = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_RESET\n)\nexport const onFieldLoading = createFieldEffect<DataField>(\n  LifeCycleTypes.ON_FIELD_LOADING\n)\n\nexport function onFieldInit(\n  pattern: FormPathPattern,\n  callback?: (field: GeneralField, form: Form) => void\n) {\n  const form = useEffectForm()\n  const count = form.query(pattern).reduce((count, field) => {\n    callback(field, form)\n    return count + 1\n  }, 0)\n  if (count === 0) {\n    _onFieldInit(pattern, callback)\n  }\n}\n\nexport function onFieldReact(\n  pattern: FormPathPattern,\n  callback?: (field: GeneralField, form: Form) => void\n) {\n  onFieldInit(pattern, (field, form) => {\n    field.disposers.push(\n      autorun(() => {\n        if (isFn(callback)) callback(field, form)\n      })\n    )\n  })\n}\nexport function onFieldChange(\n  pattern: FormPathPattern,\n  callback?: (field: GeneralField, form: Form) => void\n): void\nexport function onFieldChange(\n  pattern: FormPathPattern,\n  watches: (keyof IFieldState)[],\n  callback?: (field: GeneralField, form: Form) => void\n): void\nexport function onFieldChange(\n  pattern: FormPathPattern,\n  watches: any,\n  callback?: (field: GeneralField, form: Form) => void\n): void {\n  if (isFn(watches)) {\n    callback = watches\n    watches = ['value']\n  } else {\n    watches = watches || ['value']\n  }\n  onFieldInit(pattern, (field, form) => {\n    if (isFn(callback)) callback(field, form)\n    const dispose = reaction(\n      () => {\n        return toArr(watches).map((key) => {\n          return field[key]\n        })\n      },\n      () => {\n        if (isFn(callback)) callback(field, form)\n      }\n    )\n    field.disposers.push(dispose)\n  })\n}\n"]}