{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/upload/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { useEffect } from 'react'\nimport { Field } from '@formily/core'\nimport { useField } from '@formily/react'\nimport { reaction } from '@formily/reactive'\nimport { Upload as NextUpload, Button, Icon } from '@alifd/next'\nimport {\n  UploadProps as NextUploadProps,\n  CardProps,\n} from '@alifd/next/lib/upload'\nimport { isArr, toArr } from '@formily/shared'\nimport { UPLOAD_PLACEHOLDER } from './placeholder'\n\ntype ExtendsUploadProps = NextUploadProps & {\n  textContent?: React.ReactNode\n  serviceErrorMessage?: string\n}\n\ntype FileList = Parameters<ExtendsUploadProps['onChange']>[0]\n\ntype ComposedUpload = React.FC<React.PropsWithChildren<IUploadProps>> & {\n  Card?: React.FC<React.PropsWithChildren<ICardUploadProps>>\n  Dragger?: React.FC<React.PropsWithChildren<IUploadProps>>\n}\n\ntype IExtendsUploadProps = {\n  value?: any[]\n  serviceErrorMessage?: string\n  onChange?: (...args: any) => void\n  formatter?: (...args: any) => any\n}\n\nexport type IUploadProps = ExtendsUploadProps & { serviceErrorMessage?: string }\n\nexport type ICardUploadProps = CardProps & { serviceErrorMessage?: string }\n\nconst testOpts = (\n  ext: RegExp,\n  options: { exclude?: string[]; include?: string[] }\n) => {\n  if (options && isArr(options.include)) {\n    return options.include.some((url) => ext.test(url))\n  }\n\n  if (options && isArr(options.exclude)) {\n    return !options.exclude.some((url) => ext.test(url))\n  }\n\n  return true\n}\n\nconst getImageByUrl = (url: string, options: any) => {\n  for (let i = 0; i < UPLOAD_PLACEHOLDER.length; i++) {\n    if (\n      UPLOAD_PLACEHOLDER[i].ext.test(url) &&\n      testOpts(UPLOAD_PLACEHOLDER[i].ext, options)\n    ) {\n      return UPLOAD_PLACEHOLDER[i].icon || url\n    }\n  }\n\n  return url\n}\n\nconst getURL = (target: any) => {\n  return target?.['url'] || target?.['downloadURL'] || target?.['imgURL']\n}\n\nconst getThumbURL = (target: any) => {\n  return (\n    target?.['thumbUrl'] ||\n    target?.['url'] ||\n    target?.['downloadURL'] ||\n    target?.['imgURL']\n  )\n}\n\nconst getSuccess = (target: any) => {\n  return (\n    target?.success ||\n    target?.status === 'done' ||\n    target?.status === 'success' ||\n    target?.state === 'done' ||\n    target?.state === 'success'\n  )\n}\n\nconst getErrorMessage = (target: any) => {\n  return (\n    target?.errorMessage ||\n    target?.errMsg ||\n    target?.errorMsg ||\n    target?.message ||\n    (typeof target?.error === 'string' ? target.error : '')\n  )\n}\n\nconst getState = (target: any) => {\n  if (target?.success === false) return 'error'\n  if (target?.failed === true) return 'error'\n  if (target?.error) return 'error'\n  return target?.state || target?.status\n}\n\nconst normalizeFileList = (fileList: IUploadProps['value']) => {\n  if (fileList && fileList.length) {\n    return fileList.map(({ ...file }, index) => {\n      delete file['originFileObj']\n      return {\n        ...file,\n        uid: file.uid || index,\n        state: getState(file?.response) || getState(file),\n        downloadURL: getURL(file) || getURL(file?.response),\n        imgURL: getImageByUrl(\n          getThumbURL(file) || getThumbURL(file?.response),\n          {\n            exclude: ['.png', '.jpg', '.jpeg', '.gif'],\n          }\n        ),\n      }\n    })\n  }\n  return []\n}\n\nconst useValidator = (validator: (value: any) => string) => {\n  const field = useField<Field>()\n  useEffect(() => {\n    const dispose = reaction(\n      () => field.value,\n      (value) => {\n        const message = validator(value)\n        field.setFeedback({\n          type: 'error',\n          code: 'UploadError',\n          messages: message ? [message] : [],\n        })\n      }\n    )\n    return () => {\n      dispose()\n    }\n  }, [])\n}\n\nconst useUploadValidator = (serviceErrorMessage = 'Upload Service Error') => {\n  useValidator((value) => {\n    const list = toArr(value)\n    for (let i = 0; i < list.length; i++) {\n      if (list[i]?.state === 'error') {\n        return (\n          getErrorMessage(list[i]?.response) ||\n          getErrorMessage(list[i]) ||\n          serviceErrorMessage\n        )\n      }\n    }\n  })\n}\n\nfunction useUploadProps<T extends IExtendsUploadProps = IUploadProps>({\n  serviceErrorMessage,\n  ...props\n}: T) {\n  useUploadValidator(serviceErrorMessage)\n  const onChange = (fileList: FileList) => {\n    props.onChange?.(normalizeFileList([...fileList]))\n  }\n\n  const formatter = (res: any, file: any) => {\n    const response = props?.formatter?.(res, file) as any\n    return {\n      ...res,\n      success: getSuccess(res),\n      ...response,\n    }\n  }\n  return {\n    ...props,\n    value: normalizeFileList(props.value),\n    onChange,\n    formatter,\n  }\n}\n\nconst getPlaceholder = (props: IUploadProps) => {\n  if (props.shape !== 'card') {\n    return (\n      <Button>\n        <Icon type=\"upload\" />\n        {props.textContent}\n      </Button>\n    )\n  }\n  return <Icon type=\"upload\" style={{ fontSize: 20 }} />\n}\n\nexport const Upload: ComposedUpload = (props) => {\n  return (\n    <NextUpload listType=\"text\" {...useUploadProps(props)}>\n      {props.children || getPlaceholder(props)}\n    </NextUpload>\n  )\n}\n\nUpload.Dragger = (props) => {\n  return <NextUpload.Dragger listType=\"text\" {...useUploadProps(props)} />\n}\n\nUpload.Card = (props) => {\n  return <NextUpload.Card listType=\"card\" {...useUploadProps(props)} />\n}\n\nexport default Upload\n"]}