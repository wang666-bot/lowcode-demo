{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/form-dialog/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { Fragment, useRef, useLayoutEffect, useState } from 'react'\nimport { createPortal } from 'react-dom'\nimport { createForm, IFormProps, Form } from '@formily/core'\nimport { toJS } from '@formily/reactive'\nimport { FormProvider, Observer, observer, ReactFC } from '@formily/react'\nimport {\n  isNum,\n  isStr,\n  isBool,\n  isFn,\n  applyMiddleware,\n  IMiddleware,\n} from '@formily/shared'\nimport { Dialog, ConfigProvider, Button } from '@alifd/next'\nimport { DialogProps } from '@alifd/next/lib/dialog'\nimport {\n  usePrefixCls,\n  loading,\n  createPortalProvider,\n  createPortalRoot,\n} from '../__builtins__'\n\ntype FormDialogRenderer =\n  | React.ReactElement\n  | ((form: Form) => React.ReactElement)\n\ntype ModalTitle = string | number | React.ReactElement\n\nconst getContext: () => any = ConfigProvider['getContext']\n\nconst isModalTitle = (props: any): props is ModalTitle => {\n  return (\n    isNum(props) || isStr(props) || isBool(props) || React.isValidElement(props)\n  )\n}\n\nconst getModelProps = (props: any): IDialogProps => {\n  if (isModalTitle(props)) {\n    return {\n      title: props,\n    }\n  } else {\n    return props\n  }\n}\n\nexport interface IDialogProps extends DialogProps {\n  onOk?: (event: React.MouseEvent) => void | boolean\n  onCancel?: (event: React.MouseEvent) => void | boolean\n  loadingText?: React.ReactText\n}\n\nexport interface IFormDialog {\n  forOpen(middleware: IMiddleware<IFormProps>): IFormDialog\n  forConfirm(middleware: IMiddleware<Form>): IFormDialog\n  forCancel(middleware: IMiddleware<Form>): IFormDialog\n  open(props?: IFormProps): Promise<any>\n  close(): void\n}\n\nexport function FormDialog(\n  title: IDialogProps,\n  id: string,\n  renderer: FormDialogRenderer\n): IFormDialog\nexport function FormDialog(\n  title: IDialogProps,\n  renderer: FormDialogRenderer\n): IFormDialog\nexport function FormDialog(\n  title: ModalTitle,\n  id: string,\n  renderer: FormDialogRenderer\n): IFormDialog\nexport function FormDialog(\n  title: ModalTitle,\n  renderer: FormDialogRenderer\n): IFormDialog\nexport function FormDialog(title: any, id: any, renderer?: any): IFormDialog {\n  if (isFn(id) || React.isValidElement(id)) {\n    renderer = id\n    id = 'form-dialog'\n  }\n  const env = {\n    host: document.createElement('div'),\n    form: null,\n    promise: null,\n    openMiddlewares: [],\n    confirmMiddlewares: [],\n    cancelMiddlewares: [],\n  }\n  const root = createPortalRoot(env.host, id)\n  const props = getModelProps(title)\n  const modal = {\n    ...props,\n    style: {\n      width: '40%',\n      ...props.style,\n    },\n    afterClose: () => {\n      props?.afterClose?.()\n      root.unmount()\n    },\n  }\n  const DialogContent = observer(() => {\n    return <Fragment>{isFn(renderer) ? renderer(env.form) : renderer}</Fragment>\n  })\n  const renderDialog = (\n    visible = true,\n    resolve?: () => any,\n    reject?: () => any\n  ) => {\n    const ctx = getContext()\n    const prefix = modal.prefix || ctx.prefix || 'next'\n    const okProps = {\n      children: ctx?.locale?.Dialog?.ok || '确定',\n      ...(ctx?.defaultPropsConfig?.Dialog?.okProps || {}),\n      ...(modal.okProps || {}),\n    }\n    const cancelProps = {\n      children: ctx?.locale?.Dialog?.cancel || '取消',\n      ...(ctx?.defaultPropsConfig?.Dialog?.cancelProps || {}),\n      ...(modal.cancelProps || {}),\n    }\n    const buttonMap = {\n      ok: (\n        <Button\n          key=\"ok\"\n          type=\"primary\"\n          className={prefix + '-dialog-btn'}\n          loading={env.form.submitting}\n          onClick={(e) => {\n            if (modal?.onOk?.(e) !== false) {\n              resolve()\n            }\n          }}\n          {...okProps}\n        />\n      ),\n      cancel: (\n        <Button\n          key=\"cancel\"\n          className={prefix + '-dialog-btn'}\n          onClick={(e) => {\n            if (modal?.onCancel?.(e) !== false) {\n              reject()\n            }\n          }}\n          {...cancelProps}\n        />\n      ),\n    }\n    const footerActions = ctx?.defaultPropsConfig?.Dialog?.footerActions ||\n      modal.footerActions || ['cancel', 'ok']\n\n    return (\n      <ConfigProvider {...ctx}>\n        <Observer>\n          {() => (\n            <Dialog\n              {...modal}\n              visible={visible}\n              footer={\n                <Fragment>\n                  {footerActions.map((item) => buttonMap[item])}\n                </Fragment>\n              }\n              onClose={(trigger, e) => {\n                modal?.onClose?.(trigger, e)\n                reject()\n              }}\n            >\n              <FormProvider form={env.form}>\n                <DialogContent />\n              </FormProvider>\n            </Dialog>\n          )}\n        </Observer>\n      </ConfigProvider>\n    )\n  }\n  document.body.appendChild(env.host)\n  const formDialog = {\n    forOpen: (middleware: IMiddleware<IFormProps>) => {\n      if (isFn(middleware)) {\n        env.openMiddlewares.push(middleware)\n      }\n      return formDialog\n    },\n    forConfirm: (middleware: IMiddleware<Form>) => {\n      if (isFn(middleware)) {\n        env.confirmMiddlewares.push(middleware)\n      }\n      return formDialog\n    },\n    forCancel: (middleware: IMiddleware<Form>) => {\n      if (isFn(middleware)) {\n        env.cancelMiddlewares.push(middleware)\n      }\n      return formDialog\n    },\n    open: async (props: IFormProps) => {\n      if (env.promise) return env.promise\n      env.promise = new Promise(async (resolve, reject) => {\n        try {\n          props = await loading(modal.loadingText, () =>\n            applyMiddleware(props, env.openMiddlewares)\n          )\n          env.form = env.form || createForm(props)\n        } catch (e) {\n          reject(e)\n        }\n        root.render(() =>\n          renderDialog(\n            true,\n            () => {\n              env.form\n                .submit(async () => {\n                  await applyMiddleware(env.form, env.confirmMiddlewares)\n                  resolve(toJS(env.form.values))\n                  formDialog.close()\n                })\n                .catch(() => {})\n            },\n            async () => {\n              await loading(modal.loadingText, () =>\n                applyMiddleware(env.form, env.cancelMiddlewares)\n              )\n              formDialog.close()\n            }\n          )\n        )\n      })\n      return env.promise\n    },\n    close: () => {\n      if (!env.host) return\n      root.render(() => renderDialog(false))\n    },\n  }\n  return formDialog\n}\n\nconst DialogFooter: ReactFC = (props) => {\n  const ref = useRef<HTMLDivElement>()\n  const [footer, setFooter] = useState<HTMLDivElement>()\n  const footerRef = useRef<HTMLDivElement>()\n  const prefixCls = usePrefixCls('dialog')\n  useLayoutEffect(() => {\n    const content = ref.current?.closest(`.${prefixCls}`)\n    if (content) {\n      if (!footerRef.current) {\n        footerRef.current = content.querySelector(`.${prefixCls}-footer`)\n        if (!footerRef.current) {\n          footerRef.current = document.createElement('div')\n          footerRef.current.classList.add(`${prefixCls}-footer`)\n          content.appendChild(footerRef.current)\n        }\n      }\n      setFooter(footerRef.current)\n    }\n  })\n\n  footerRef.current = footer\n\n  return (\n    <div ref={ref} style={{ display: 'none' }}>\n      {footer && createPortal(props.children, footer)}\n    </div>\n  )\n}\n\nFormDialog.Footer = DialogFooter\n\nFormDialog.Portal = createPortalProvider('form-dialog')\n\nexport default FormDialog\n"]}