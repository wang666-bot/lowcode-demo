import rules from './rules';
/**
 * {required, format} => format; {required} => required
 * If a promise is wanted from the validator, either return a promise from the callback,
 *      or do not pass a callback
 */
export function validateFunc(validator, ruleType) {
    return function (rule, value, cb, options) {
        var errors = [];
        // 如果是非 required 校验
        if (ruleType !== 'required') {
            var errors_1 = [];
            rules.required(rule, value, errors_1, options);
            // 空数据
            if (errors_1.length > 0) {
                if ('required' in rule && rule.required) {
                    if (cb) {
                        return cb(errors_1);
                    }
                    else {
                        return Promise.reject(errors_1);
                    }
                }
                else if (cb) {
                    return cb([]); //空数据，并且没有 require 要求，则忽略
                }
                else {
                    return Promise.resolve(null);
                }
            }
        }
        validator(rule, value, errors, options);
        if (cb) {
            return cb(errors);
        }
        if (Promise) {
            return Promise.resolve(errors);
        }
    };
}
/**
 * {required, format} => format; {required} => required
 */
export function getValidationMethod(rule) {
    if (typeof rule.validator === 'function') {
        return rule.validator;
    }
    var keys = Object.keys(rule);
    // required 和其他校验规则共存
    // {required, format} {required, unknown}
    for (var i = 0; i < keys.length; i++) {
        var ruleType = keys[i];
        if (ruleType === 'required') {
            continue;
        }
        if (ruleType in rules) {
            return validateFunc(rules[ruleType], ruleType);
        }
    }
    // 有其他位置参数
    if ('required' in rule && rule.required) {
        return validateFunc(rules.required, 'required');
    }
    return null;
}
